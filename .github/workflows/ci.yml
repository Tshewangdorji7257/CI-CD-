name: CI Pipeline

# Trigger the workflow on push events to the main branch
on:
  push:
    branches:
      - main

# Define environment variables that will be used throughout the workflow
env:
  NODE_VERSION: '18.x'

jobs:
  # Main CI job that runs all the pipeline steps
  ci:
    name: Continuous Integration
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the code from the repository
      # This action checks out your repository so the workflow can access it
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Fetch all history for all branches and tags (required for SonarCloud)
          fetch-depth: 0

      # Step 2: Set up Node.js environment
      # This installs Node.js which is required for running Jest tests and building the project
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # Cache npm dependencies to speed up subsequent workflow runs
          cache: 'npm'

      # Step 3: Install project dependencies
      # This installs all dependencies defined in package.json
      - name: Install dependencies
        run: npm ci

      # Step 4: Run unit tests using Jest
      # Execute all unit tests to ensure code functionality
      - name: Run unit tests
        run: npm test
        env:
          # Run tests in CI mode for better output formatting
          CI: true

      # Step 5: Run Snyk security scan
      # Scan for vulnerabilities in dependencies and code
      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          # Snyk token should be stored as a GitHub secret
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          # Generate a report showing vulnerabilities
          args: --severity-threshold=high

      # Step 7: Build the project
      # Compile/build the project to ensure it can be built successfully
      - name: Build project
        run: npm run build

      # Optional: Upload build artifacts
      # Store the build output for potential deployment or review
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: build-artifacts
          path: |
            dist/
            build/
          retention-days: 7

      # Optional: Report CI status
      # Summarize the CI results
      - name: CI Summary
        if: always()
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Code checkout completed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Dependencies installed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Unit tests executed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Security scan completed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Project build completed" >> $GITHUB_STEP_SUMMARY
