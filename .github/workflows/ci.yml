name: CI Pipeline

# Trigger the workflow on push events to the main branch
on:
  push:
    branches:
      - main

# Define environment variables that will be used throughout the workflow
env:
  GO_VERSION: '1.21'

jobs:
  # Main CI job that runs all the pipeline steps
  ci:
    name: Continuous Integration
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the code from the repository
      # This action checks out your repository so the workflow can access it
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Go environment
      # This installs Go which is required for building and testing the microservices
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      # Step 3: Install dependencies for all services
      # Download all Go module dependencies for each microservice
      - name: Install dependencies
        run: |
          echo "Installing dependencies for all services..."
          cd api-gateway && go mod download && cd ..
          cd auth-service && go mod download && cd ..
          cd booking-service && go mod download && cd ..
          cd building-service && go mod download && cd ..

      # Step 4: Run unit tests
      # Execute tests for all microservices
      - name: Run unit tests
        run: |
          echo "Running tests for all services..."
          cd api-gateway && go test ./... -v && cd ..
          cd auth-service && go test ./... -v && cd ..
          cd booking-service && go test ./... -v && cd ..
          cd building-service && go test ./... -v && cd ..

      # Step 5: Run Snyk security scan
      # Scan for vulnerabilities in dependencies and code
      - name: Run Snyk security scan
        uses: snyk/actions/golang@master
        continue-on-error: true
        env:
          # Snyk token should be stored as a GitHub secret
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      # Step 6: Build all microservices
      # Compile all services to ensure they can be built successfully
      - name: Build all services
        run: |
          echo "Building all microservices..."
          cd api-gateway && go build -v -o ../bin/api-gateway . && cd ..
          cd auth-service && go build -v -o ../bin/auth-service . && cd ..
          cd booking-service && go build -v -o ../bin/booking-service . && cd ..
          cd building-service && go build -v -o ../bin/building-service . && cd ..

      # Step 7: Upload build artifacts
      # Store the compiled binaries for potential deployment
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: microservices-binaries
          path: bin/
          retention-days: 7

      # Step 8: Generate CI summary
      # Summarize the CI results
      - name: CI Summary
        if: always()
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Code checkout completed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Go environment configured" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Dependencies installed for all services" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Unit tests executed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Security scan completed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ All microservices built successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services Built:" >> $GITHUB_STEP_SUMMARY
          echo "- API Gateway" >> $GITHUB_STEP_SUMMARY
          echo "- Auth Service" >> $GITHUB_STEP_SUMMARY
          echo "- Booking Service" >> $GITHUB_STEP_SUMMARY
          echo "- Building Service" >> $GITHUB_STEP_SUMMARY
